/*
 * Acorn Media Player - jQuery plugin 1.1
 *
 * Copyright (C) 2010 Cristian I. Colceriu
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 * www.ghinda.net
 * contact@ghinda.net
 *
 */
(function(c){c.fn.acornMediaPlayer=function(g){g=c.extend({theme:"access",nativeSliders:false,volumeSlider:"horizontal",captionsOn:false},g);var h=function(){try{return"localStorage"in window&&window.localStorage!==null}catch(a){return false}}?localStorage.getItem("acornvolume"):1;h||(h=1);return this.each(function(){var a={$self:c(this)},j,i,p,t,e={play:"Play",playTitle:"Start the playback",pause:"Pause",pauseTitle:"Pause the playback",mute:"Mute",unmute:"Unmute",fullscreen:"Fullscreen",fullscreenTitle:"Toggle fullscreen mode",
volumeTitle:"Volume control",seekTitle:"Video seek control",captions:"Captions",captionsTitle:"Show captions",captionsChoose:"Choose caption",transcript:"Transcript",transcriptTitle:"Show transcript"},C=c('<div class="acorn-player" role="application"></div>').addClass(g.theme);a.$self.attr("tabindex","0");a.id=a.$self.attr("id");if(!a.id){a.id="acorn"+(new Date).getTime();a.$self.attr("id",a.id)}var q=a.$self.is("video")?'<button class="acorn-fullscreen-button" title="'+e.fullscreenTitle+'" aria-controls="'+
a.id+'">'+e.fullscreen+"</button>":"";q='<div class="acorn-controls" style="display: none;"><button class="acorn-play-button" id="shn" title="'+e.playTitle+'" aria-controls="'+a.id+'">'+e.play+'</button><input type="range" class="acorn-seek-slider" title="'+e.seekTitle+'" value="0" min="0" max="150" step="0.1" aria-controls="'+a.id+'"/><span class="acorn-timer">00:00</span><div class="acorn-volume-box"><button class="acorn-volume-button" title="'+e.mute+'" aria-controls="'+a.id+'">'+e.mute+'</button><input type="range" class="acorn-volume-slider" title="'+
e.volumeTitle+'" value="1" min="0" max="1" step="0.05" aria-controls="'+a.id+'"/></div>'+q+'<button class="acorn-caption-button" title="'+e.captionsTitle+'"  aria-controls="'+a.id+'">'+e.captions+'</button><div class="acorn-caption-selector"></div><button class="acorn-transcript-button" title="'+e.transcriptTitle+'">'+e.transcript+"</button></div>";a.$self.wrap(C).after(q);a.$container=a.$self.parent(".acorn-player");a.$controls=c(".acorn-controls",a.$container);a.$playBtn=c(".acorn-play-button",
a.$container);a.$seek=c(".acorn-seek-slider",a.$container);a.$timer=c(".acorn-timer",a.$container);a.$volume=c(".acorn-volume-slider",a.$container);a.$volumeBtn=c(".acorn-volume-button",a.$container);a.$fullscreenBtn=c(".acorn-fullscreen-button",a.$container);a.$controls.after('<div class="acorn-caption"></div>');a.$container.after('<div class="acorn-transcript" role="region" aria-live="assertive"></div>');a.$transcript=a.$container.next(".acorn-transcript");a.$transcriptBtn=c(".acorn-transcript-button",
a.$container);a.$caption=c(".acorn-caption",a.$container);a.$captionBtn=c(".acorn-caption-button",a.$container);a.$captionSelector=c(".acorn-caption-selector",a.$container);a.$self.attr("data-width",a.$self.width());a.$self.attr("data-height",a.$self.height());var D=function(b){var d=Math.floor(b/60)<10?"0"+Math.floor(b/60):Math.floor(b/60);return d+":"+(Math.floor(b-d*60)<10?"0"+Math.floor(b-d*60):Math.floor(b-d*60))},u=function(){a.$self.attr("paused")?a.$self.trigger("play"):a.$self.trigger("pause")},
E=function(){a.$playBtn.text(e.pause).attr("title",e.pauseTitle);a.$playBtn.addClass("acorn-paused-button")},v=function(){a.$playBtn.text(e.play).attr("title",e.playTitle);a.$playBtn.removeClass("acorn-paused-button")},F=function(){var b=a.$self.attr("currentTime");a.$timer.text(D(b));j||(g.nativeSliders?a.$seek.attr("value",b):a.$seek.slider("value",b));t&&w()},x=function(b){var d=Math.floor(b/60)<10?""+Math.floor(b/60):Math.floor(b/60);b=Math.floor(b-d*60)<10?""+Math.floor(b-d*60):Math.floor(b-
d*60);if(d==1)min="minute";return d===0?b+" seconds":d+" minutes "+b+" seconds"},n=function(){a.$captionBtn.trigger("blur")},r=function(b,d){a.$self.attr("paused")||(i=true);a.$self.trigger("pause");j=true;var f;f=g.nativeSliders?a.$seek.val():d.value;a.$self.attr("currentTime",f);n()},y=function(b,d){if(i){a.$self.trigger("play");i=false}j=false;var f=c(d.handle);f.attr("aria-valuenow",parseInt(d.value,10));f.attr("aria-valuetext",x(d.value))},z=function(b,d){var f={role:"slider","aria-valuenow":parseInt(d.value,
10),"aria-valuemin":parseInt(d.min,10),"aria-valuemax":parseInt(d.max,10),"aria-valuetext":d.valuetext,tabindex:"0"};b.attr(f)},G=function(){var b=parseInt(a.$self.attr("duration"),10),d=this.buffered;if(d&&d.length){b=parseInt(this.buffered.end(0)-this.buffered.start(0),10)*100/b;a.$buffer.css("width",b+"%")}},H=function(b,d){h=d.value;localStorage.setItem("acornvolume",h);if(a.$self.attr("muted")){a.$self.attr("muted",false);a.$volumeBtn.removeClass("acorn-volume-mute");a.$volumeBtn.text(e.mute).attr("title",
e.mute)}a.$self.attr("volume",h);a.$volume.$handle.attr("aria-valuenow",Math.round(h*100));a.$volume.$handle.attr("aria-valuetext",Math.round(h*100)+" percent");n()},I=function(){if(a.$self.attr("muted")===true){a.$self.attr("muted",false);g.nativeSliders?a.$volume.val(h):a.$volume.slider("value",h);a.$volumeBtn.removeClass("acorn-volume-mute");a.$volumeBtn.text(e.mute).attr("title",e.mute)}else{a.$self.attr("muted",true);g.nativeSliders?a.$volume.val("0"):a.$volume.slider("value","0");a.$volumeBtn.addClass("acorn-volume-mute");
a.$volumeBtn.text(e.unmute).attr("title",e.unmute)}},J=function(){if(g.nativeSliders)a.$volume.bind("change",function(){a.$self.attr("muted",false);h=a.$volume.val();a.$self.attr("volume",h)});else{var b=a.$volume.attr("class");a.$volume.after('<div class="'+b+'" title="'+e.volumeTitle+'"></div>').remove();a.$volume=c("."+b,a.$container);b={value:h,orientation:g.volumeSlider,range:"min",max:1,min:0,step:0.1,animate:true,slide:H};a.$volume.slider(b);a.$volume.$handle=a.$volume.find(".ui-slider-handle");
b.max=100;b.value*=100;b.valuetext=b.value+" percent";z(a.$volume.$handle,b);c(".ui-slider-handle",a.$volume).click(n)}a.$volumeBtn.click(I)},K=function(){a.$self.attr({width:c(window).width(),height:c(window).height()})},L=function(){if(p){if(a.$self[0].webkitSupportsFullscreen)a.$self[0].webkitExitFullScreen();else{c("body").css("overflow","auto");var b=a.$self.attr("data-width"),d=a.$self.attr("data-height");a.$self.removeClass("fullscreen-video").attr({width:b,height:d});c(window).unbind("resize");
a.$controls.removeClass("fullscreen-controls")}p=false}else{if(a.$self[0].webkitSupportsFullscreen)a.$self[0].webkitEnterFullScreen();else{c("body").css("overflow","hidden");a.$self.addClass("fullscreen-video").attr({width:c(window).width(),height:c(window).height()});c(window).resize(K);a.$controls.addClass("fullscreen-controls")}p=true}},k="acornCaptions"+(new Date).getTime(),s=function(){captions="";a.$caption.hide();activeCaptions=false;a.$transcriptBtn.removeClass("acorn-transcript-active").hide();
a.$transcript.hide();a.$captionBtn.removeClass("acorn-caption-active")},w=function(){for(var b=a.$self[0].currentTime,d="",f=0;f<captions.length;f++)if(b>=captions[f].start&&b<=captions[f].end){d=captions[f].content;break}a.$caption.html(d)},M=function(){var b=function(){var m=a.$captionBtn.offset(),A=m.top-a.$captionSelector.outerHeight(true);m=m.left-(a.$captionSelector.outerWidth(true)-a.$captionBtn.outerWidth(true))/2;var B=a.$controls.offset();m-=B.left;A-=B.top;a.$captionSelector.css({top:A,
left:m})};a.$fullscreenBtn.click(b);c(window).resize(function(){b()});b();var d,f=function(){d&&clearTimeout(d);a.$captionSelector.show()},l=function(){d=setTimeout(function(){a.$captionSelector.hide()},200)};a.$captionBtn.click(function(){c(this).focus()});a.$captionBtn.bind("focus",f);a.$captionBtn.bind("blur",l);c("input[name="+k+"]",a.$container).bind("focus",f);c("input[name="+k+"]",a.$container).bind("blur",l);a.$captionSelector.attr("tabindex","-1");a.$captionSelector.bind("focus",f);a.$captionSelector.bind("blur",
l)},o=function(b){a.$captionBtn.addClass("acorn-caption-loading");c.ajax({url:b,success:function(d){captions=parseSrt(d);a.$transcriptBtn.show();var f="";c(captions).each(function(){f+='<span data-begin="'+parseInt(this.start,10)+'" data-end='+parseInt(this.end,10)+">"+this.content.replace("'","")+"</span>"});a.$transcript.html(f);a.$caption.show();t=true;a.$self.attr("paused")&&w();a.$captionBtn.addClass("acorn-caption-active").removeClass("acorn-caption-loading")},error:function(){s();console&&
console.log("Error loading captions")}})},N=function(){c(this).hasClass("acorn-transcript-active")?a.$transcript.hide():a.$transcript.show();c(this).toggleClass("acorn-transcript-active")},O=function(){a.$track=c("track",a.$self);a.$track.length&&a.$captionBtn.show();if(a.$track.length>1){a.$captionBtn.attr("title",e.captionsChoose);var b='<ul><li><label><input type="radio" name="'+k+'" checked="true" />None</label></li>';a.$track.each(function(){c(this).attr("src");b+='<li><label><input type="radio" name="'+
k+'" data-url="'+c(this).attr("src")+'" />'+c(this).attr("label")+"</label></li>"});b+="</ul>";a.$captionSelector.html(b);c("input[name="+k+"]",a.$container).change(function(){var l=c(this).attr("data-url");l?o(l):s()});M();var d=a.$track.first().attr("src");if(g.captionsOn){o(d);c("input[name="+k+"]",a.$container).removeAttr("checked");c("input[name="+k+"]:eq(1)",a.$container).attr("checked","true")}}else if(a.$track.length){var f=a.$track.attr("src");a.$captionBtn.bind("click",function(){c(this).hasClass("acorn-caption-active")?
s():o(f);c(this).toggleClass("acorn-caption-active")});g.captionsOn&&o(f)}a.$transcriptBtn.bind("click",N)};(function(){a.$playBtn.click(u);a.$self.click(u);a.$self.bind("play",E);a.$self.bind("pause",v);a.$self.bind("ended",v);a.$self.bind("timeupdate",F);a.$fullscreenBtn.click(L);J();a.$self.bind("progress",G);a.$self.bind("loadedmetadata",function(){var b=a.$self.attr("duration");if(g.nativeSliders){a.$seek.attr("max",b);a.$seek.bind("change",r);a.$seek.bind("mousedown",r);a.$seek.bind("mouseup",
y)}else{var d=a.$seek.attr("class");a.$seek.after('<div class="'+d+'" title="'+e.seekTitle+'"></div>').remove();a.$seek=c("."+d,a.$container);a.$seek.append('<div class="ui-slider-range acorn-buffer"></div>');a.$buffer=c(".acorn-buffer",a.$container);b={value:0,step:1,orientation:"horizontal",range:"min",min:0,max:b,slide:r,stop:y};a.$seek.slider(b);b.valuetext=x(b.value);z(a.$seek.find(".ui-slider-handle"),b);c(".ui-slider-handle",a.$seek).click(n)}a.$controls.show();a.$self.removeClass("loading-media");
O()});a.$self.removeAttr("controls");a.$self.addClass("loading-media");a.$self.is("audio")&&a.$container.addClass("audio-player")})()})}})(jQuery);
function parseSrt(c){var g=c.replace(/\r+/g,"");g=g.replace(/^\s+|\s+$/g,"");g=g.replace(/<[a-zA-Z\/][^>]*>/g,"");c=[];g=g.split("\n\n");for(var h=0;h<g.length;h+=1){var a="",j,i;a=g[h];j=a.split(/\n/);if(j[0].match(/^\d+$/)&&j[1].match(/\d+:\d+:\d+/))if(i=j[1].match(/(\d+):(\d+):(\d+)(?:,(\d+))?\s*--?>\s*(\d+):(\d+):(\d+)(?:,(\d+))?/)){a=parseInt(i[1],10)*60*60+parseInt(i[2],10)*60+parseInt(i[3],10)+parseInt(i[4],10)/1E3;i=parseInt(i[5],10)*60*60+parseInt(i[6],10)*60+parseInt(i[7],10)+parseInt(i[8],
10)/1E3;j=j.slice(2).join("<br>");c.push({start:a,end:i,content:j})}}return c};